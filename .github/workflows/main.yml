name: ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        type: choice
        options:
          - 'latest-commit'
          - 'commit-1'
          - 'commit-2'
          - 'commit-3'
          - 'commit-4'
          - 'commit-5'
          - 'latest-tag'
          - 'specific-tag'
          - 'specific-commit'
        default: 'latest-commit'
      version:
        description: 'æŒ‡å®šç‰ˆæœ¬ (å½“é€‰æ‹© specific-tag æˆ– specific-commit æ—¶å¿…å¡«)'
        required: false
        type: string
      confirm_deploy:
        description: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
        required: true
        type: boolean
        default: false

jobs:
  get-commit-info:
    runs-on: ubuntu-latest
    outputs:
      commit_info: ${{ steps.get-commits.outputs.commit_info }}
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 10  # è·å–æœ€è¿‘10ä¸ªæäº¤

    - name: ğŸ“‹ è·å–æœ€è¿‘æäº¤ä¿¡æ¯
      id: get-commits
      run: |
        echo "## ğŸ” æœ€è¿‘å¯é€‰æ‹©çš„æäº¤ (è¯·è®°ä½è¿™äº›ä¿¡æ¯ç”¨äºé€‰æ‹©)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # è·å–æœ€è¿‘5ä¸ªæäº¤çš„è¯¦ç»†ä¿¡æ¯
        commit_info=""
        for i in {0..4}; do
          commit_sha=$(git rev-parse HEAD~$i 2>/dev/null || echo "")
          if [ -n "$commit_sha" ]; then
            short_sha=$(git rev-parse --short HEAD~$i)
            commit_message=$(git log -1 --pretty=format:"%s" HEAD~$i)
            commit_author=$(git log -1 --pretty=format:"%an" HEAD~$i)
            commit_date=$(git log -1 --pretty=format:"%ai" HEAD~$i)
            
            if [ $i -eq 0 ]; then
              echo "ğŸŸ¢ latest-commit: $short_sha - $commit_message"
            else
              echo "ğŸ”µ commit-$((i+1)): $short_sha - $commit_message"
            fi
            echo "   ğŸ‘¤ $commit_author"
            echo "   ğŸ“… $commit_date"
            echo ""
            
            # ä¿å­˜ä¿¡æ¯ä¾›åç»­ä½¿ç”¨
            commit_info="${commit_info}COMMIT_${i}_SHA=${commit_sha}|COMMIT_${i}_SHORT=${short_sha}|COMMIT_${i}_MESSAGE=${commit_message}|COMMIT_${i}_AUTHOR=${commit_author}|COMMIT_${i}_DATE=${commit_date}||"
          fi
        done
        
        echo "commit_info<<EOF" >> $GITHUB_OUTPUT
        echo "$commit_info" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ’¡ è¯·æ ¹æ®ä¸Šé¢çš„ä¿¡æ¯é€‰æ‹© 'latest-commit' æˆ– 'commit-1' åˆ° 'commit-5'"

  validate-and-fetch-version:
    needs: get-commit-info
    runs-on: ubuntu-latest
    outputs:
      deploy_version: ${{ steps.determine-version.outputs.deploy_version }}
      commit_sha: ${{ steps.determine-version.outputs.commit_sha }}
      commit_message: ${{ steps.determine-version.outputs.commit_message }}
      commit_author: ${{ steps.determine-version.outputs.commit_author }}
      commit_date: ${{ steps.determine-version.outputs.commit_date }}
      version_info: ${{ steps.determine-version.outputs.version_info }}
    steps:
    - name: ğŸ” éªŒè¯è¾“å…¥å‚æ•°
      run: |
        if [ "${{ inputs.confirm_deploy }}" != "true" ]; then
          echo "âŒ è¯·ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
          exit 1
        fi
        
        if [ "${{ inputs.version_type }}" = "specific-tag" ] || [ "${{ inputs.version_type }}" = "specific-commit" ]; then
          if [ -z "${{ inputs.version }}" ]; then
            echo "âŒ é€‰æ‹©äº†æŒ‡å®šç‰ˆæœ¬ç±»å‹ï¼Œä½†æœªæä¾›ç‰ˆæœ¬ä¿¡æ¯"
            exit 1
          fi
        fi
        
        echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿æŸ¥çœ‹æ ‡ç­¾å’Œæäº¤

    - name: ğŸ¯ ç¡®å®šéƒ¨ç½²ç‰ˆæœ¬
      id: determine-version
      run: |
        # è§£ææäº¤ä¿¡æ¯
        commit_info="${{ needs.get-commit-info.outputs.commit_info }}"
        
        case "${{ inputs.version_type }}" in
          "latest-commit")
            commit_sha=$(git rev-parse HEAD)
            deploy_version=$commit_sha
            version_info="æœ€æ–°æäº¤"
            ;;
          "commit-1")
            commit_sha=$(git rev-parse HEAD~0)
            deploy_version=$commit_sha
            short_sha=$(git rev-parse --short HEAD~0)
            commit_msg=$(git log -1 --pretty=format:"%s" HEAD~0)
            version_info="ç¬¬1ä¸ªæäº¤: $short_sha - $commit_msg"
            ;;
          "commit-2")
            commit_sha=$(git rev-parse HEAD~1)
            deploy_version=$commit_sha
            short_sha=$(git rev-parse --short HEAD~1)
            commit_msg=$(git log -1 --pretty=format:"%s" HEAD~1)
            version_info="ç¬¬2ä¸ªæäº¤: $short_sha - $commit_msg"
            ;;
          "commit-3")
            commit_sha=$(git rev-parse HEAD~2)
            deploy_version=$commit_sha
            short_sha=$(git rev-parse --short HEAD~2)
            commit_msg=$(git log -1 --pretty=format:"%s" HEAD~2)
            version_info="ç¬¬3ä¸ªæäº¤: $short_sha - $commit_msg"
            ;;
          "commit-4")
            commit_sha=$(git rev-parse HEAD~3)
            deploy_version=$commit_sha
            short_sha=$(git rev-parse --short HEAD~3)
            commit_msg=$(git log -1 --pretty=format:"%s" HEAD~3)
            version_info="ç¬¬4ä¸ªæäº¤: $short_sha - $commit_msg"
            ;;
          "commit-5")
            commit_sha=$(git rev-parse HEAD~4)
            deploy_version=$commit_sha
            short_sha=$(git rev-parse --short HEAD~4)
            commit_msg=$(git log -1 --pretty=format:"%s" HEAD~4)
            version_info="ç¬¬5ä¸ªæäº¤: $short_sha - $commit_msg"
            ;;
          "latest-tag")
            # è·å–æœ€æ–°æ ‡ç­¾
            latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$latest_tag" ]; then
              echo "âŒ æœªæ‰¾åˆ°ä»»ä½•æ ‡ç­¾ï¼Œå°†ä½¿ç”¨æœ€æ–°æäº¤"
              commit_sha=$(git rev-parse HEAD)
              deploy_version=$commit_sha
              version_info="æœ€æ–°æäº¤ (æ— æ ‡ç­¾)"
            else
              commit_sha=$(git rev-list -n 1 $latest_tag)
              deploy_version=$latest_tag
              version_info="æœ€æ–°æ ‡ç­¾: $latest_tag"
            fi
            ;;
          "specific-tag")
            # éªŒè¯æ ‡ç­¾æ˜¯å¦å­˜åœ¨
            if git rev-parse "refs/tags/${{ inputs.version }}" >/dev/null 2>&1; then
              commit_sha=$(git rev-list -n 1 "refs/tags/${{ inputs.version }}")
              deploy_version="${{ inputs.version }}"
              version_info="æŒ‡å®šæ ‡ç­¾: ${{ inputs.version }}"
            else
              echo "âŒ æ ‡ç­¾ '${{ inputs.version }}' ä¸å­˜åœ¨"
              echo "ğŸ“‹ å¯ç”¨æ ‡ç­¾ï¼š"
              git tag -l | head -10
              exit 1
            fi
            ;;
          "specific-commit")
            # éªŒè¯æäº¤SHAæ˜¯å¦å­˜åœ¨
            if git rev-parse "${{ inputs.version }}" >/dev/null 2>&1; then
              commit_sha=$(git rev-parse "${{ inputs.version }}")
              deploy_version="${{ inputs.version }}"
              version_info="æŒ‡å®šæäº¤: ${{ inputs.version }}"
            else
              echo "âŒ æäº¤ '${{ inputs.version }}' ä¸å­˜åœ¨"
              exit 1
            fi
            ;;
        esac
        
        # è·å–æäº¤è¯¦ç»†ä¿¡æ¯
        commit_message=$(git log -1 --pretty=format:"%s" $commit_sha)
        commit_author=$(git log -1 --pretty=format:"%an <%ae>" $commit_sha)
        commit_date=$(git log -1 --pretty=format:"%ai" $commit_sha)
        
        # è¾“å‡ºä¿¡æ¯
        echo "deploy_version=$deploy_version" >> $GITHUB_OUTPUT
        echo "commit_sha=$commit_sha" >> $GITHUB_OUTPUT
        echo "commit_message<<EOF" >> $GITHUB_OUTPUT
        echo "$commit_message" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "commit_author<<EOF" >> $GITHUB_OUTPUT
        echo "$commit_author" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "commit_date=$commit_date" >> $GITHUB_OUTPUT
        echo "version_info<<EOF" >> $GITHUB_OUTPUT
        echo "$version_info" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "âœ… ç‰ˆæœ¬ä¿¡æ¯ç¡®å®šå®Œæˆ"

  list-recent-versions:
    needs: [get-commit-info, validate-and-fetch-version]
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ“‹ æ˜¾ç¤ºé€‰æ‹©çš„ç‰ˆæœ¬è¯¦æƒ…
      run: |
        echo "## ğŸ“¦ å½“å‰éƒ¨ç½²ç‰ˆæœ¬è¯¦æƒ…"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ·ï¸  ç‰ˆæœ¬ç±»å‹: ${{ inputs.version_type }}"
        echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: ${{ needs.validate-and-fetch-version.outputs.version_info }}"
        echo "ğŸ”– éƒ¨ç½²ç‰ˆæœ¬: ${{ needs.validate-and-fetch-version.outputs.deploy_version }}"
        echo "ğŸ“ æäº¤SHA: ${{ needs.validate-and-fetch-version.outputs.commit_sha }}"
        echo "ğŸ’¬ æäº¤ä¿¡æ¯: ${{ needs.validate-and-fetch-version.outputs.commit_message }}"
        echo "ğŸ‘¤ æäº¤ä½œè€…: ${{ needs.validate-and-fetch-version.outputs.commit_author }}"
        echo "ğŸ“… æäº¤æ—¶é—´: ${{ needs.validate-and-fetch-version.outputs.commit_date }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        echo "## ğŸ“‹ æœ€è¿‘å¯ç”¨æ ‡ç­¾ (æœ€æ–°10ä¸ª)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if git tag -l | head -1 >/dev/null 2>&1; then
          git tag -l --sort=-version:refname | head -10 | while read tag; do
            if [ -n "$tag" ]; then
              tag_commit=$(git rev-list -n 1 $tag 2>/dev/null || echo "unknown")
              tag_date=$(git log -1 --pretty=format:"%ai" $tag 2>/dev/null || echo "unknown")
              tag_message=$(git tag -l --format='%(contents:subject)' $tag 2>/dev/null || git log -1 --pretty=format:"%s" $tag 2>/dev/null || echo "No message")
              echo "ğŸ·ï¸  $tag"
              echo "   ğŸ“ $tag_message"
              echo "   ğŸ“… $tag_date"
              echo "   ğŸ”— $tag_commit"
              echo ""
            fi
          done
        else
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½•æ ‡ç­¾"
        fi
        
        echo "## ğŸ“‹ æœ€è¿‘æäº¤å†å² (å‚è€ƒ)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        git log --oneline --decorate -10 --pretty=format:"ğŸ”— %h - %s%n   ğŸ‘¤ %an <%ae>%n   ğŸ“… %ai%n"

  deploy:
    needs: [validate-and-fetch-version, list-recent-versions]
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: http://your-server:8010
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“‹ éƒ¨ç½²ä¿¡æ¯æ‘˜è¦
      run: |
        echo "## ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ¯ ç¯å¢ƒ: ç”Ÿäº§ç¯å¢ƒ"
        echo "ğŸ·ï¸  ç‰ˆæœ¬ç±»å‹: ${{ inputs.version_type }}"
        echo "ğŸ“¦ éƒ¨ç½²ç‰ˆæœ¬: ${{ needs.validate-and-fetch-version.outputs.deploy_version }}"
        echo "ğŸ“ æäº¤SHA: ${{ needs.validate-and-fetch-version.outputs.commit_sha }}"
        echo "ğŸ’¬ æäº¤ä¿¡æ¯: ${{ needs.validate-and-fetch-version.outputs.commit_message }}"
        echo "ğŸ‘¤ æäº¤ä½œè€…: ${{ needs.validate-and-fetch-version.outputs.commit_author }}"
        echo "ğŸ“… æäº¤æ—¶é—´: ${{ needs.validate-and-fetch-version.outputs.commit_date }}"
        echo "ğŸ‘¨â€ğŸ’» æ“ä½œäººå‘˜: ${{ github.actor }}"
        echo "ğŸ• éƒ¨ç½²æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: ğŸš€ æ‰§è¡Œéƒ¨ç½²
      run: |
        echo "ğŸŒ æ­£åœ¨éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨..."
        echo "ğŸ“¦ éƒ¨ç½²é•œåƒç‰ˆæœ¬: ${{ needs.validate-and-fetch-version.outputs.deploy_version }}"
        echo "ğŸ¯ ç›®æ ‡æœåŠ¡å™¨: ${{ secrets.SSH_HOST }}"
        chmod +x scripts/one_click_deploy_remote.sh
        export API_VERSION=${{ needs.validate-and-fetch-version.outputs.deploy_version }}
        export ALI_REGISTRY_USERNAME=${{ secrets.ALI_REGISTRY_USERNAME }}
        export ALI_REGISTRY_PASSWORD=${{ secrets.ALI_REGISTRY_PASSWORD }}
        export ALI_REGISTRY_URL=${{ secrets.ALI_REGISTRY_URL }}
        export PROJECT_NAME="${{ vars.PROJECT_NAME || 'naibaoai' }}"
        export DEPLOY_HOST=${{ secrets.SSH_HOST }}
        export DEPLOY_USER=${{ secrets.SSH_USER }}
        export DEPLOY_DIR=${{ secrets.DEPLOY_DIR }}
        export SSH_PRIVATE_KEY="${{ secrets.SSH_KEY }}"
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
        ./scripts/one_click_deploy_remote.sh

    - name: âœ… éƒ¨ç½²å®Œæˆ
      run: |
        echo "## ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ å·²éƒ¨ç½²ç‰ˆæœ¬: ${{ needs.validate-and-fetch-version.outputs.deploy_version }}"
        echo "ğŸ“ æäº¤ä¿¡æ¯: ${{ needs.validate-and-fetch-version.outputs.commit_message }}"
        echo "ğŸ‘¤ æäº¤ä½œè€…: ${{ needs.validate-and-fetch-version.outputs.commit_author }}"
        echo "ğŸŒ API åœ°å€: http://${{ secrets.SSH_HOST }}:8010"
        echo "ğŸ‘¨â€ğŸ’¼ ç®¡ç†åœ°å€: http://${{ secrets.SSH_HOST }}:8011"
        echo "â° å®Œæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" 
